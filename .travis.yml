sudo: required

services:
  - docker

env:
  - REPO=cryptotuga/neo-sharp

before_install:
  - docker --version

install:
  - docker build --target builder -t $REPO:SDK ./containers/

script:
  - docker run -p 8000:8000 -it --rm --name neo-sharp-SDK $REPO:SDK bash -c "cd /repo/neo-sharp && find test -name *.csproj | xargs -I % dotnet add % package coverlet.msbuild && dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover"

after_success:
  - docker exec neo-sharp-SDK "/bin/bash <(curl -s https://codecov.io/bash) -v"
  - docker build -t $REPO:latest ./containers/
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - docker push $REPO:SDK
  - docker push $REPO
