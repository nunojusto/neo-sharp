language: csharp
os:
  - linux
dist: trusty
dotnet: 2.1.402
mono: none
sudo: required

services:
  - docker

install:
  # build container image
  - docker build -t cityofzion/neo-sharp:latest ./containers/

script:
  # run tests
  - dotnet restore
  - find test -name *.csproj | xargs -I % dotnet add % package coverlet.msbuild
  - dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
  - docker run -p 8000:8000 -d --rm --name neo-sharp-node cityofzion/neo-sharp:latest
  - bash -c "sleep 10;if [ $(docker inspect -f '{{.State.Running}}' neo-sharp-node) = 'true' ]; then exit 0; else echo 'neo-sharp Node is not starting inside the clean runtime container!!' && exit 1; fi"

after_success:
  # if tests ok publish CodeDev report
  - bash <(curl -s https://codecov.io/bash) -v
